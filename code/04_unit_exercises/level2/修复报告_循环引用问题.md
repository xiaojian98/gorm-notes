# GORM Level 2 å…³è”å…³ç³»ç»ƒä¹  - å¾ªç¯å¼•ç”¨é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

åœ¨ç¼–è¯‘ `level2_associations.go` æ–‡ä»¶æ—¶é‡åˆ°äº†ä»¥ä¸‹é”™è¯¯ï¼š

```
.\level2_associations.go:28:6: invalid recursive type User
        .\level2_associations.go:28:6: User refers to
        .\level2_associations.go:39:6: Profile refers to
        .\level2_associations.go:28:6: User
```

## é—®é¢˜åˆ†æ

### ğŸ” æ ¹æœ¬åŸå› 

**å¾ªç¯å¼•ç”¨é—®é¢˜**ï¼šåœ¨ Go è¯­è¨€ä¸­ï¼Œå½“ä¸¤ä¸ªç»“æ„ä½“ç›¸äº’å¼•ç”¨æ—¶ä¼šå½¢æˆå¾ªç¯ä¾èµ–ï¼Œå¯¼è‡´ç¼–è¯‘å™¨æ— æ³•ç¡®å®šç»“æ„ä½“çš„å¤§å°ã€‚

**å…·ä½“è¡¨ç°**ï¼š
- `User` ç»“æ„ä½“åŒ…å« `Profile` å­—æ®µ
- `Profile` ç»“æ„ä½“åŒ…å« `User` å­—æ®µ
- å½¢æˆäº† `User -> Profile -> User` çš„å¾ªç¯å¼•ç”¨

### ğŸ“‹ åŸå§‹ä»£ç ç»“æ„

```go
// User ç»“æ„ä½“
type User struct {
    BaseModel
    Username string `gorm:"uniqueIndex;size:50;not null" json:"username"`
    Email    string `gorm:"uniqueIndex;size:100;not null" json:"email"`
    Password string `gorm:"size:255;not null" json:"-"`
    
    // ä¸€å¯¹ä¸€å…³ç³»ï¼šç”¨æˆ·èµ„æ–™
    Profile Profile `gorm:"constraint:OnUpdate:CASCADE,OnDelete:CASCADE;" json:"profile,omitempty"`
}

// Profile ç»“æ„ä½“
type Profile struct {
    BaseModel
    UserID    uint       `gorm:"uniqueIndex;not null" json:"user_id"`
    // ... å…¶ä»–å­—æ®µ
    
    // åå‘å…³è” - é—®é¢˜æ‰€åœ¨
    User User `gorm:"foreignKey:UserID" json:"user,omitempty"`  // âŒ å¾ªç¯å¼•ç”¨
}
```

## è§£å†³æ–¹æ¡ˆ

### âœ… ä¿®å¤æ–¹æ³•

**ä½¿ç”¨æŒ‡é’ˆç±»å‹æ‰“ç ´å¾ªç¯å¼•ç”¨**ï¼šå°† `Profile` ç»“æ„ä½“ä¸­çš„ `User` å­—æ®µæ”¹ä¸ºæŒ‡é’ˆç±»å‹ `*User`ã€‚

### ğŸ“ ä¿®å¤åçš„ä»£ç 

```go
// Profile ç”¨æˆ·èµ„æ–™æ¨¡å‹
type Profile struct {
    BaseModel
    UserID    uint       `gorm:"uniqueIndex;not null" json:"user_id"`
    FirstName string     `gorm:"size:50" json:"first_name"`
    LastName  string     `gorm:"size:50" json:"last_name"`
    Bio       string     `gorm:"type:text" json:"bio"`
    Avatar    string     `gorm:"size:255" json:"avatar"`
    Phone     string     `gorm:"size:20" json:"phone"`
    Address   string     `gorm:"size:255" json:"address"`
    BirthDate *time.Time `json:"birth_date"`

    // åå‘å…³è” - ä½¿ç”¨æŒ‡é’ˆç±»å‹é¿å…å¾ªç¯å¼•ç”¨
    User *User `gorm:"foreignKey:UserID" json:"user,omitempty"`  // âœ… ä¿®å¤
}
```

## æŠ€æœ¯åŸç†

### ğŸ”§ ä¸ºä»€ä¹ˆæŒ‡é’ˆèƒ½è§£å†³é—®é¢˜ï¼Ÿ

1. **å†…å­˜å¸ƒå±€**ï¼š
   - å€¼ç±»å‹ï¼šç¼–è¯‘å™¨éœ€è¦çŸ¥é“å®Œæ•´çš„ç»“æ„ä½“å¤§å°
   - æŒ‡é’ˆç±»å‹ï¼šå›ºå®šå¤§å°ï¼ˆ64ä½ç³»ç»Ÿä¸Šä¸º8å­—èŠ‚ï¼‰ï¼Œä¸ä¾èµ–äºæŒ‡å‘å¯¹è±¡çš„å¤§å°

2. **ç¼–è¯‘æ—¶è§£æ**ï¼š
   - å€¼ç±»å‹ï¼šéœ€è¦é€’å½’è®¡ç®—æ‰€æœ‰åµŒå¥—å­—æ®µçš„å¤§å°
   - æŒ‡é’ˆç±»å‹ï¼šåªéœ€è¦åˆ†é…æŒ‡é’ˆæœ¬èº«çš„ç©ºé—´

3. **è¿è¡Œæ—¶è¡Œä¸º**ï¼š
   - æŒ‡é’ˆå¯ä»¥ä¸º `nil`ï¼Œé¿å…äº†å¿…é¡»åˆå§‹åŒ–çš„é—®é¢˜
   - å»¶è¿ŸåŠ è½½ï¼Œåªæœ‰åœ¨éœ€è¦æ—¶æ‰è®¿é—®å…³è”å¯¹è±¡

### ğŸ“Š å†…å­˜å¯¹æ¯”

| æ–¹æ¡ˆ | User ç»“æ„ä½“å¤§å° | Profile ç»“æ„ä½“å¤§å° | ç¼–è¯‘ç»“æœ |
|------|----------------|-------------------|----------|
| å€¼ç±»å‹ | æ— æ³•ç¡®å®š | æ— æ³•ç¡®å®š | âŒ ç¼–è¯‘å¤±è´¥ |
| æŒ‡é’ˆç±»å‹ | ç¡®å®šå¤§å° | ç¡®å®šå¤§å° | âœ… ç¼–è¯‘æˆåŠŸ |

## GORM å…³è”å…³ç³»æœ€ä½³å®è·µ

### ğŸ¯ è®¾è®¡åŸåˆ™

1. **ä¸»ä»å…³ç³»æ˜ç¡®**ï¼š
   - ä¸»è¡¨ï¼ˆUserï¼‰ï¼šåŒ…å«å…³è”å¯¹è±¡çš„å€¼ç±»å‹
   - ä»è¡¨ï¼ˆProfileï¼‰ï¼šåŒ…å«åå‘å…³è”çš„æŒ‡é’ˆç±»å‹

2. **é¿å…åŒå‘å€¼å¼•ç”¨**ï¼š
   - âœ… æ¨èï¼š`User.Profile` (å€¼) + `Profile.User` (æŒ‡é’ˆ)
   - âŒ é¿å…ï¼š`User.Profile` (å€¼) + `Profile.User` (å€¼)

3. **åˆç†ä½¿ç”¨é¢„åŠ è½½**ï¼š
   ```go
   // é¢„åŠ è½½å…³è”æ•°æ®
   var user User
   db.Preload("Profile").First(&user, 1)
   
   var profile Profile
   db.Preload("User").First(&profile, 1)
   ```

### ğŸ”„ å¸¸è§å…³è”æ¨¡å¼

#### ä¸€å¯¹ä¸€å…³ç³»
```go
type User struct {
    ID      uint
    Profile Profile // å€¼ç±»å‹
}

type Profile struct {
    ID     uint
    UserID uint
    User   *User `gorm:"foreignKey:UserID"` // æŒ‡é’ˆç±»å‹
}
```

#### ä¸€å¯¹å¤šå…³ç³»
```go
type User struct {
    ID    uint
    Posts []Post // åˆ‡ç‰‡ç±»å‹
}

type Post struct {
    ID     uint
    UserID uint
    User   *User `gorm:"foreignKey:UserID"` // æŒ‡é’ˆç±»å‹
}
```

#### å¤šå¯¹å¤šå…³ç³»
```go
type User struct {
    ID    uint
    Roles []Role `gorm:"many2many:user_roles;"` // åˆ‡ç‰‡ç±»å‹
}

type Role struct {
    ID    uint
    Users []User `gorm:"many2many:user_roles;"` // åˆ‡ç‰‡ç±»å‹
}
```

## éªŒè¯ç»“æœ

### âœ… ç¼–è¯‘æµ‹è¯•

```bash
$ go build ./level2/
# ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯è¾“å‡º
```

### ğŸ§ª åŠŸèƒ½éªŒè¯

ä¿®å¤åçš„ä»£ç åº”è¯¥èƒ½å¤Ÿæ­£å¸¸ï¼š
1. åˆ›å»ºç”¨æˆ·å’Œèµ„æ–™çš„å…³è”å…³ç³»
2. æŸ¥è¯¢ç”¨æˆ·æ—¶é¢„åŠ è½½èµ„æ–™ä¿¡æ¯
3. æŸ¥è¯¢èµ„æ–™æ—¶åå‘å…³è”ç”¨æˆ·ä¿¡æ¯
4. æ‰§è¡Œæ•°æ®åº“è¿ç§»å’Œçº¦æŸè®¾ç½®

## ç»éªŒæ€»ç»“

### ğŸ’¡ å…³é”®è¦ç‚¹

1. **å¾ªç¯å¼•ç”¨è¯†åˆ«**ï¼šå½“çœ‹åˆ° "invalid recursive type" é”™è¯¯æ—¶ï¼Œç«‹å³æ£€æŸ¥ç»“æ„ä½“é—´çš„ç›¸äº’å¼•ç”¨

2. **æŒ‡é’ˆè§£å†³æ–¹æ¡ˆ**ï¼šåœ¨åå‘å…³è”ä¸­ä½¿ç”¨æŒ‡é’ˆç±»å‹æ˜¯æ ‡å‡†åšæ³•

3. **è®¾è®¡è€ƒè™‘**ï¼šåœ¨è®¾è®¡æ•°æ®æ¨¡å‹æ—¶ï¼Œæå‰è€ƒè™‘å…³è”å…³ç³»çš„æ–¹å‘æ€§

4. **æ€§èƒ½å½±å“**ï¼šæŒ‡é’ˆç±»å‹åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å¸¦æ¥é¢å¤–çš„å†…å­˜åˆ†é…ï¼Œä½†é€šå¸¸æ˜¯å¯æ¥å—çš„

### ğŸš€ åç»­å»ºè®®

1. **å®Œå–„æµ‹è¯•**ï¼šä¸ºå…³è”å…³ç³»ç¼–å†™å•å…ƒæµ‹è¯•
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ ¹æ®å®é™…ä½¿ç”¨åœºæ™¯ä¼˜åŒ–é¢„åŠ è½½ç­–ç•¥
3. **æ–‡æ¡£å®Œå–„**ï¼šä¸ºå¤æ‚çš„å…³è”å…³ç³»æ·»åŠ è¯¦ç»†æ³¨é‡Š
4. **ä»£ç å®¡æŸ¥**ï¼šåœ¨å›¢é˜Ÿä¸­å»ºç«‹å…³è”å…³ç³»è®¾è®¡çš„å®¡æŸ¥æ ‡å‡†

## ç›¸å…³èµ„æº

- [GORM å®˜æ–¹æ–‡æ¡£ - å…³è”å…³ç³»](https://gorm.io/docs/associations.html)
- [Go è¯­è¨€è§„èŒƒ - ç±»å‹å£°æ˜](https://golang.org/ref/spec#Type_declarations)
- [GORM é¢„åŠ è½½æŒ‡å—](https://gorm.io/docs/preload.html)

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2024å¹´12æœˆ19æ—¥  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… æˆåŠŸè§£å†³  
**å½±å“èŒƒå›´**ï¼šlevel2_associations.go æ–‡ä»¶  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… ç¼–è¯‘é€šè¿‡