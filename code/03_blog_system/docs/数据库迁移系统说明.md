# 数据库迁移系统说明

## 问题背景

在之前的博客系统中，每次重启服务都需要清理数据库表，这是因为：

1. **GORM AutoMigrate 的局限性**：GORM 的 `AutoMigrate` 在处理模型变更时可能产生约束冲突
2. **约束命名冲突**：当模型定义发生变化时，GORM 可能尝试删除不存在的约束
3. **缺乏版本控制**：没有迁移版本管理，无法追踪数据库结构变更历史

## 解决方案

### 1. 迁移版本控制系统

创建了一个完整的数据库迁移管理系统，包含以下组件：

#### 核心文件结构
```
migrations/
├── migration.go     # 迁移管理器核心逻辑
└── versions.go      # 具体迁移版本定义
```

#### 主要功能

**迁移管理器 (MigrationManager)**
- `AddMigration()`: 添加迁移版本
- `RunMigrations()`: 执行所有未运行的迁移
- `RollbackMigration()`: 回滚指定迁移
- `GetMigrationStatus()`: 获取迁移状态

**迁移版本控制**
- 每个迁移都有唯一的版本号和名称
- 支持 Up（执行）和 Down（回滚）操作
- 自动记录迁移执行状态和时间

### 2. 迁移版本定义

当前定义了三个迁移版本：

#### 001_initial_schema
- **目的**：创建初始数据库结构
- **操作**：执行 GORM AutoMigrate 创建所有基础表
- **回滚**：删除所有相关表

#### 002_create_indexes
- **目的**：创建数据库索引
- **操作**：为 Like、Post、Comment 表创建复合索引
- **回滚**：删除相应索引

#### 003_fix_constraints
- **目的**：修复外键约束问题
- **操作**：处理可能的约束冲突
- **回滚**：恢复原始约束

### 3. 使用方式

在 `main.go` 中，原来的：
```go
models.AutoMigrate(config.DB)
```

替换为：
```go
if err := migrations.RunMigrations(config.DB); err != nil {
    log.Fatalf("数据库迁移失败:%v", err)
}
```

## 优势对比

### 之前的问题
- ❌ 每次重启需要清理数据库
- ❌ 数据丢失风险
- ❌ 无法追踪数据库变更历史
- ❌ 约束冲突导致启动失败

### 新系统的优势
- ✅ **数据保护**：不再需要清理数据库，保护现有数据
- ✅ **版本控制**：完整的迁移历史记录
- ✅ **智能迁移**：只执行未运行的迁移
- ✅ **回滚支持**：支持迁移回滚操作
- ✅ **约束管理**：妥善处理约束冲突
- ✅ **生产就绪**：适合生产环境使用

## 最佳实践

### 1. 添加新迁移

当需要修改数据库结构时：

1. 在 `versions.go` 中添加新的迁移版本
2. 定义 Up 和 Down 函数
3. 更新 `GetAllMigrations()` 函数

示例：
```go
// 004_add_user_avatar
func migration004Up(db *gorm.DB) error {
    return db.Exec("ALTER TABLE users ADD COLUMN avatar VARCHAR(255)").Error
}

func migration004Down(db *gorm.DB) error {
    return db.Exec("ALTER TABLE users DROP COLUMN avatar").Error
}
```

### 2. 迁移命名规范

- 版本号：三位数字，如 001, 002, 003
- 名称：简洁描述，使用下划线分隔
- 示例：`001_initial_schema`, `002_add_user_avatar`

### 3. 安全注意事项

- **备份数据**：执行迁移前务必备份数据库
- **测试环境**：先在测试环境验证迁移
- **回滚准备**：确保每个迁移都有对应的回滚操作
- **分步执行**：复杂变更分解为多个小迁移

## 故障排除

### 常见问题

1. **迁移失败**
   - 检查数据库连接
   - 查看错误日志
   - 验证 SQL 语法

2. **约束冲突**
   - 检查现有约束
   - 使用 `IF EXISTS` 语句
   - 分步处理约束变更

3. **回滚失败**
   - 确保回滚逻辑正确
   - 检查数据依赖关系
   - 手动修复数据状态

### 调试命令

```sql
-- 查看迁移状态
SELECT * FROM Migration ORDER BY version;

-- 查看表结构
DESC table_name;

-- 查看约束
SHOW CREATE TABLE table_name;
```

## 总结

新的迁移系统彻底解决了"每次重启都要清理数据库"的问题，提供了：

- 🛡️ **数据安全**：保护现有数据不丢失
- 📋 **版本管理**：完整的变更历史追踪
- 🔄 **智能更新**：只执行必要的迁移
- 🏭 **生产就绪**：适合生产环境的稳定方案

这是一个科学、合理且符合行业最佳实践的数据库管理方案。